# services.yml

rules:
  # -------------------------
  # Core Windows / AD signals
  # -------------------------

  - bucket: smb
    service_names: [microsoft-ds, netbios-ssn]

  - bucket: rpc
    service_names: [msrpc, rpcbind]
    ports:
      - { proto: tcp, port: 135 }

  - bucket: rdp
    service_names: [ms-wbt-server, rdp]

  - bucket: winrm
    # WinRM is frequently identified as HTTP (Microsoft HTTPAPI), so key off ports first.
    ports:
      - { proto: tcp, port: 5985 }   # WinRM HTTP
      - { proto: tcp, port: 5986 }   # WinRM HTTPS
      - { proto: tcp, port: 47001 }  # WinRM/WSMan related endpoint

  
  # Adding rule for wsdapi to prevent false positives for HTTP
  - bucket: wsdapi
    # Windows Web Services for Devices (often shows up as Microsoft HTTPAPI httpd)
    ports:
      - { proto: tcp, port: 5357 }

  - bucket: kerberos
    service_names: [kerberos, kerberos-sec]
    ports:
      - { proto: tcp, port: 88 }
      - { proto: udp, port: 88 }
      - { proto: tcp, port: 464 }
      - { proto: udp, port: 464 }

  - bucket: ldap
    service_names: [ldap]
    ports:
      - { proto: tcp, port: 389 }
      - { proto: udp, port: 389 }

  - bucket: ldaps
    service_names: [ldaps]
    ports:
      - { proto: tcp, port: 636 }

  - bucket: global_catalog
    ports:
      - { proto: tcp, port: 3268 }
      - { proto: tcp, port: 3269 }

  - bucket: dns
    service_names: [domain, dns]
    ports:
      - { proto: tcp, port: 53 }
      - { proto: udp, port: 53 }

  - bucket: ntp
    service_names: [ntp]
    ports:
      - { proto: udp, port: 123 }

  - bucket: snmp
    service_names: [snmp]
    ports:
      - { proto: udp, port: 161 }
      - { proto: udp, port: 162 }

  # --------------
  # Remote access
  # --------------

  - bucket: ssh
    service_names: [ssh]

  - bucket: telnet
    service_names: [telnet]
    ports:
      - { proto: tcp, port: 23 }

  - bucket: vnc
    service_names: [vnc]
    ports:
      - { proto: tcp, port: 5900 }
      - { proto: tcp, port: 5901 }
      - { proto: tcp, port: 5902 }
      - { proto: tcp, port: 5903 }
      - { proto: tcp, port: 5904 }
      - { proto: tcp, port: 5905 }

  # -----------------
  # Web (more specific)
  # -----------------
   
  - bucket: iis
    service_names: [http, https]
    regex:
      - field: product
        pattern: '(?i)Microsoft.*IIS'

  - bucket: tomcat
    service_names: [http, https]
    regex:
      - field: product
        pattern: '(?i)Tomcat|Apache.*Tomcat'

  - bucket: apache
    service_names: [http, https]
    regex:
      - field: product
        pattern: '(?i)Apache.*httpd'

  - bucket: nginx
    service_names: [http, https]
    regex:
      - field: product
        pattern: '(?i)\bnginx\b'


  - bucket: http
    # Generic web catch-all last, so WinRM/WSDAPI donâ€™t pollute this bucket.
    service_names: [http, https]
    ports:
      - { proto: tcp, port: 80 }
      - { proto: tcp, port: 443 }
      - { proto: tcp, port: 8080 }
      - { proto: tcp, port: 8000 }
      - { proto: tcp, port: 8008 }
      - { proto: tcp, port: 8081 }
      - { proto: tcp, port: 8443 }
      - { proto: tcp, port: 8888 }

  # --------------------
  # Email
  # --------------------

  - bucket: smtp
    service_names: [smtp, smtps]
    ports:
      - { proto: tcp, port: 25 }
      - { proto: tcp, port: 465 }
      - { proto: tcp, port: 587 }

  - bucket: imap
    service_names: [imap, imaps]
    ports:
      - { proto: tcp, port: 143 }
      - { proto: tcp, port: 993 }

  - bucket: pop3
    service_names: [pop3, pop3s]
    ports:
      - { proto: tcp, port: 110 }
      - { proto: tcp, port: 995 }

  # -------------
  # File services
  # -------------

  - bucket: ftp
    service_names: [ftp]
    ports:
      - { proto: tcp, port: 21 }

  - bucket: nfs
    service_names: [nfs, mountd]
    ports:
      - { proto: tcp, port: 2049 }
      - { proto: udp, port: 2049 }

  # --------------
  # Databases
  # --------------

  - bucket: mysql
    service_names: [mysql]
    ports:
      - { proto: tcp, port: 3306 }

  - bucket: postgres
    service_names: [postgresql]
    ports:
      - { proto: tcp, port: 5432 }

  - bucket: mssql
    service_names: [ms-sql-s, mssql]
    ports:
      - { proto: tcp, port: 1433 }

  - bucket: mongodb
    service_names: [mongodb]
    ports:
      - { proto: tcp, port: 27017 }

  - bucket: redis
    service_names: [redis]
    ports:
      - { proto: tcp, port: 6379 }

  - bucket: elasticsearch
    ports:
      - { proto: tcp, port: 9200 }
      - { proto: tcp, port: 9300 }

  # -----------------------
  # Containers / orchestration
  # -----------------------

  - bucket: k8s_api
    # Common APIs that use HTTPS -- adding rule to prevent false positives
    ports:
      - { proto: tcp, port: 6443 }

  - bucket: docker
    ports:
      - { proto: tcp, port: 2375 }
      - { proto: tcp, port: 2376 }

  - bucket: consul
    ports:
      - { proto: tcp, port: 8500 }
      - { proto: tcp, port: 8501 }

  # -----------------------
  # Miscellaneous SSL
  # -----------------------

  # Adding ssl_misc so if there are any ports i missed i can add later
  - bucket: ssl_misc
    regex:
      - field: service
        pattern: "^ssl"


